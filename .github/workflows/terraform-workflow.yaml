name: Terraform Dev Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'aws/**'
      - 'modules/**'
  workflow_dispatch:

jobs:
  # -------------------------
  # Detect what changed
  # -------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      vpc: ${{ steps.filter.outputs.vpc }}
      eks: ${{ steps.filter.outputs.eks }}
      node: ${{ steps.filter.outputs.node }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Detect changed files
        id: files
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # First commit â†’ consider all changed
            echo "vpc=true" >> $GITHUB_ENV
            echo "eks=true" >> $GITHUB_ENV
            echo "node=true" >> $GITHUB_ENV
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            echo "CHANGED_FILES=$CHANGED" >> $GITHUB_ENV

            if echo "$CHANGED" | grep -E '^aws/vpc|^modules/vpc'; then
              echo "vpc=true" >> $GITHUB_ENV
            else
              echo "vpc=false" >> $GITHUB_ENV
            fi

            if echo "$CHANGED" | grep -E '^aws/eks|^modules/eks'; then
              echo "eks=true" >> $GITHUB_ENV
            else
              echo "eks=false" >> $GITHUB_ENV
            fi

            if echo "$CHANGED" | grep -E '^aws/node-group|^modules/node-group'; then
              echo "node=true" >> $GITHUB_ENV
            else
              echo "node=false" >> $GITHUB_ENV
            fi
          fi

      - name: Set outputs for other jobs
        id: filter
        run: |
          echo "vpc=${{ env.vpc }}" >> $GITHUB_OUTPUT
          echo "eks=${{ env.eks }}" >> $GITHUB_OUTPUT
          echo "node=${{ env.node }}" >> $GITHUB_OUTPUT

  # -------------------------
  # VPC Job
  # -------------------------
  vpc:
    needs: detect-changes
    if: needs.detect-changes.outputs.vpc == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Terraform Init & Apply VPC
        run: |
          cd aws/vpc/dev/files
          terraform init
          terraform plan

  # -------------------------
  # EKS Job
  # -------------------------
  eks:
    needs: [detect-changes, vpc]
    if: needs.detect-changes.outputs.eks == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Terraform Init & Apply EKS
        run: |
          cd aws/eks/dev/files
          terraform init
          terraform plan

  # -------------------------
  # Node Group Job
  # -------------------------
  node-group:
    needs: [detect-changes, eks]
    if: needs.detect-changes.outputs.node == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Terraform Init & Apply Node Group
        run: |
          cd aws/node-group/dev/files
          terraform init
          terraform plan