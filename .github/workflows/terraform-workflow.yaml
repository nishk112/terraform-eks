name: Terraform Dev Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'aws/**'
      - 'modules/**'
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      vpc: ${{ steps.filter.outputs.vpc }}
      eks: ${{ steps.filter.outputs.eks }}
      node: ${{ steps.filter.outputs.node }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # Full history for git diff

      - name: Detect changed files
        id: files
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            # First commit or empty diff â†’ all true
            echo "vpc=true" >> $GITHUB_ENV
            echo "eks=true" >> $GITHUB_ENV
            echo "node=true" >> $GITHUB_ENV
          else
            if echo "$CHANGED_FILES" | grep -qE '^aws/vpc|^modules/vpc'; then
              echo "vpc=true" >> $GITHUB_ENV
            else
              echo "vpc=false" >> $GITHUB_ENV
            fi

            if echo "$CHANGED_FILES" | grep -qE '^aws/eks|^modules/eks'; then
              echo "eks=true" >> $GITHUB_ENV
            else
              echo "eks=false" >> $GITHUB_ENV
            fi

            if echo "$CHANGED_FILES" | grep -qE '^aws/node-group|^modules/node-group'; then
              echo "node=true" >> $GITHUB_ENV
            else
              echo "node=false" >> $GITHUB_ENV
            fi
          fi

          echo "vpc=${vpc}" >> $GITHUB_OUTPUT
          echo "eks=${eks}" >> $GITHUB_OUTPUT
          echo "node=${node}" >> $GITHUB_OUTPUT

  vpc:
    needs: detect-changes
    if: needs.detect-changes.outputs.vpc == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: |
          cd aws/vpc/dev/files
          terraform init
          terraform apply -auto-approve

  eks:
    needs: [detect-changes, vpc]
    if: needs.detect-changes.outputs.eks == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: |
          cd aws/eks/dev/files
          terraform init
          terraform apply -auto-approve

  node-group:
    needs: [detect-changes, eks]
    if: needs.detect-changes.outputs.node == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: |
          cd aws/node-group/dev/files
          terraform init
          terraform apply -auto-approve