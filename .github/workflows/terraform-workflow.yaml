name: Terraform Dev Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'aws/**'
      - 'modules/**'
  workflow_dispatch:

jobs:
  # -------------------------
  # Detect what changed
  # -------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      vpc: ${{ steps.filter.outputs.vpc }}
      eks: ${{ steps.filter.outputs.eks }}
      node: ${{ steps.filter.outputs.node }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get changed files
        id: files
        run: |
          echo "CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})"
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

      - name: Set Terraform job flags
        id: filter
        run: |
          vpc=false
          eks=false
          node=false

          if echo "$CHANGED_FILES" | grep -E '^aws/vpc|^modules/vpc'; then
            vpc=true
          fi

          if echo "$CHANGED_FILES" | grep -E '^aws/eks|^modules/eks'; then
            eks=true
          fi

          if echo "$CHANGED_FILES" | grep -E '^aws/node-group|^modules/node-group'; then
            node=true
          fi

          echo "::set-output name=vpc::$vpc"
          echo "::set-output name=eks::$eks"
          echo "::set-output name=node::$node"

  # -------------------------
  # VPC Job
  # -------------------------
  vpc:
    needs: detect-changes
    if: needs.detect-changes.outputs.vpc == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Terraform Init & Apply VPC
        run: |
          cd aws/vpc/dev/files
          terraform init
          terraform apply -auto-approve

  # -------------------------
  # EKS Job
  # -------------------------
  eks:
    needs: [detect-changes, vpc]
    if: needs.detect-changes.outputs.eks == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Terraform Init & Apply EKS
        run: |
          cd aws/eks/dev/files
          terraform init
          terraform apply -auto-approve

  # -------------------------
  # Node Group Job
  # -------------------------
  node-group:
    needs: [detect-changes, eks]
    if: needs.detect-changes.outputs.node == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Terraform Init & Apply Node Group
        run: |
          cd aws/node-group/dev/files
          terraform init
          terraform apply -auto-approve